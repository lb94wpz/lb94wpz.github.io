document.addEventListener("DOMContentLoaded",()=>{let t=!1,n,r=!0,e=CONFIG.path,s=(0===e.length?e="search.xml":e.endsWith("json")&&(r=!1),document.querySelector(".search-input")),l=document.getElementById("search-result"),g=(e,t,n)=>{CONFIG.localsearch.unescape&&((r=document.createElement("div")).innerText=e,e=r.innerHTML);var r,o=e.length;if(0===o)return[];let s=0,l,a=[];for(n||(t=t.toLowerCase(),e=e.toLowerCase());-1<(l=t.indexOf(e,s));)a.push({position:l,word:e}),s=l+o;return a},f=(e,t,n,r)=>{let o,{position:s,word:l}=n[n.length-1],a=[],i=0;for(;s+l.length<=t&&0!==n.length;){l===r&&i++,a.push({position:s,length:l.length});var c=s+l.length;for(n.pop();0!==n.length&&(o=n[n.length-1],s=o.position,l=o.word,c>s);)n.pop()}return{hits:a,start:e,end:t,searchTextCount:i}},C=(n,e)=>{let r="",o=e.start;return e.hits.forEach(e=>{r+=n.substring(o,e.position);var t=e.position+e.length;r+=`<b class="search-keyword">${n.substring(e.position,t)}</b>`,o=t}),r+=n.substring(o,e.end)},o=()=>{if(t){let d=s.value.trim().toLowerCase(),o=d.split(/[-\s]+/),p=(1<o.length&&o.push(d),[]);0<d.length&&n.forEach(({title:e,content:s,url:n})=>{let t=e.toLowerCase(),r=s.toLowerCase(),l=[],a=[],i=0;if(o.forEach(e=>{l=l.concat(g(e,t,!1)),a=a.concat(g(e,r,!1))}),0<l.length||0<a.length){var c=l.length+a.length,h=([l,a].forEach(e=>{e.sort((e,t)=>t.position!==e.position?t.position-e.position:e.word.length-t.word.length)}),[]);0!==l.length&&(u=f(0,e.length,l,d),i+=u.searchTextCountInSlice,h.push(u));let o=[];for(;0!==a.length;){let{position:e,word:t}=a[a.length-1],n=e-20,r=e+80;n<0&&(n=0),(r=r<e+t.length?e+t.length:r)>s.length&&(r=s.length),e=f(n,r,a,d),i+=e.searchTextCountInSlice,o.push(e)}o.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start);var u=parseInt(CONFIG.localsearch.top_n_per_article,10);0<=u&&(o=o.slice(0,u));let t="";t+=0!==h.length?`<li><a href="${n}" class="search-result-title">${C(e,h[0])}</a>`:`<li><a href="${n}" class="search-result-title">${e}</a>`,o.forEach(e=>{t+=`<a href="${n}"><p class="search-result">${C(s,e)}...</p></a>`}),t+="</li>",p.push({item:t,id:p.length,hitCount:c,searchTextCount:i})}}),1===o.length&&""===o[0]?l.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>':0===p.length?l.innerHTML='<div id="no-result"><i class="far fa-frown fa-5x"></i></div>':(p.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id),l.innerHTML=`<ul class="search-result-list">${p.map(e=>e.item).join("")}</ul>`,window.pjax&&window.pjax.refresh(l))}},a=()=>{fetch(CONFIG.root+e).then(e=>e.text()).then(e=>{t=!0,n=(n=r?[...(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("entry")].map(e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent})):JSON.parse(e)).filter(e=>e.title).map(e=>(e.title=e.title.trim(),e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"",e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/"),e)),document.getElementById("no-result").innerHTML='<i class="fa fa-search fa-5x"></i>',o()})},i=(CONFIG.localsearch.preload&&a(),"auto"===CONFIG.localsearch.trigger?s.addEventListener("input",o):(document.querySelector(".search-icon").addEventListener("click",o),s.addEventListener("keypress",e=>{"Enter"===e.key&&o()})),document.querySelectorAll(".popup-trigger").forEach(e=>{e.addEventListener("click",()=>{document.body.style.overflow="hidden",document.querySelector(".search-pop-overlay").classList.add("search-active"),s.focus(),t||a()})}),()=>{document.body.style.overflow="",document.querySelector(".search-pop-overlay").classList.remove("search-active")});document.querySelector(".search-pop-overlay").addEventListener("click",e=>{e.target===document.querySelector(".search-pop-overlay")&&i()}),document.querySelector(".popup-btn-close").addEventListener("click",i),window.addEventListener("pjax:success",i),window.addEventListener("keyup",e=>{"Escape"===e.key&&i()})});